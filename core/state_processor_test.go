// Copyright 2020 The go-ethereum Authors
// This file is part of the go-ethereum library.
//
// The go-ethereum library is free software: you can redistribute it and/or modify
// it under the terms of the GNU Lesser General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// The go-ethereum library is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with the go-ethereum library. If not, see <http://www.gnu.org/licenses/>.

package core

import (
	"encoding/hex"
	"math/big"
	"testing"

	"github.com/dominant-strategies/go-quai/common"
	"github.com/dominant-strategies/go-quai/consensus"
	"github.com/dominant-strategies/go-quai/consensus/blake3pow"
	"github.com/dominant-strategies/go-quai/core/rawdb"
	"github.com/dominant-strategies/go-quai/core/state"
	"github.com/dominant-strategies/go-quai/core/types"
	"github.com/dominant-strategies/go-quai/core/vm"
	"github.com/dominant-strategies/go-quai/crypto"
	"github.com/dominant-strategies/go-quai/params"
	"github.com/holiman/uint256"
)

type MockChainContext struct {
	blocks []*types.Block
}

func (c MockChainContext) Engine() consensus.Engine {
	return nil
}
func (c MockChainContext) GetHeader(common.Hash, uint64) *types.Header {
	return c.blocks[1].Header()
}

func TestPrecompile(t *testing.T) {
	// Create a simple chain to verify
	var statedb *state.StateDB
	gen := func(i int, b *BlockGen) {
		statedb = b.statedb
	}
	var (
		testdb = rawdb.NewMemoryDatabase()
		gspec  = &Genesis{
			Config: params.TestChainConfig,
			Alloc: GenesisAlloc{
				common.HexToAddress("0x71562b71999873DB5b286dF957af199Ec94617F7"): GenesisAccount{
					Balance: big.NewInt(1000000000000000000), // 1 ether
					Nonce:   0,
				},
			},
			GasLimit:   []uint64{params.GenesisGasLimit, params.GenesisGasLimit, params.GenesisGasLimit},
			Difficulty: []*big.Int{common.Big0, common.Big0, common.Big0},
			ParentHash: []common.Hash{common.HexToHash("0"), common.HexToHash("0"), common.HexToHash("0")},
			BaseFee:    []*big.Int{common.Big0, common.Big0, common.Big0},
		}
		genesis    = gspec.MustCommit(testdb)
		signer     = types.LatestSigner(params.TestChainConfig)
		testKey, _ = crypto.HexToECDSA("b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
		addr       = crypto.PubkeyToAddress(testKey.PublicKey)
		zero       = uint64(0)
		gasLimit   = GasPool(params.GenesisGasLimit)
	)
	t.Log(addr)
	common.NodeLocation = *addr.Location()
	t.Log(common.NodeLocation.Name())
	vm.InitializePrecompiles()

	toAddr := common.BytesToAddress([]byte{1})
	location := toAddr.Location()
	t.Log(location.Name())
	params.TestChainConfig.GenesisHash = genesis.Hash()
	blocks, _ := GenerateChain(params.TestChainConfig, genesis, blake3pow.NewFaker(), testdb, 2, gen)
	statedb.AddBalance(addr, big.NewInt(params.Ether*2)) // give me 2 eth
	mockContext := MockChainContext{blocks}

	inner_tx := types.InternalTx{ChainID: big.NewInt(1), Nonce: 0, GasTipCap: common.Big1, GasFeeCap: common.Big1, Gas: 100000, To: &toAddr, Value: big.NewInt(params.Ether)}
	tx, err := types.SignTx(types.NewTx(&inner_tx), signer, testKey)
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	receipt, err := ApplyTransaction(params.TestChainConfig, mockContext, &common.ZeroAddr, &gasLimit, statedb, blocks[1].Header(), tx, &zero, vm.Config{NoBaseFee: true})
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	t.Log(*receipt)
	t.Log(receipt.Status)

}

func TestCreateETX(t *testing.T) {
	// Create a simple chain to verify
	var statedb *state.StateDB
	gen := func(i int, b *BlockGen) {
		statedb = b.statedb
	}
	var (
		testdb = rawdb.NewMemoryDatabase()
		gspec  = &Genesis{
			Config: params.TestChainConfig,
			Alloc: GenesisAlloc{
				common.HexToAddress("0x71562b71999873DB5b286dF957af199Ec94617F7"): GenesisAccount{
					Balance: big.NewInt(1000000000000000000), // 1 ether
					Nonce:   0,
				},
			},
			GasLimit:   []uint64{params.GenesisGasLimit, params.GenesisGasLimit, params.GenesisGasLimit},
			Difficulty: []*big.Int{common.Big0, common.Big0, common.Big0},
			ParentHash: []common.Hash{common.HexToHash("0"), common.HexToHash("0"), common.HexToHash("0")},
			BaseFee:    []*big.Int{common.Big0, common.Big0, common.Big0},
		}
		genesis    = gspec.MustCommit(testdb)
		signer     = types.LatestSigner(params.TestChainConfig)
		testKey, _ = crypto.HexToECDSA("b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
		addr       = crypto.PubkeyToAddress(testKey.PublicKey)
		zero       = uint64(0)
		gasLimit   = GasPool(params.GenesisGasLimit)
	)
	t.Log(addr)
	common.NodeLocation = *addr.Location()
	t.Log(common.NodeLocation.Name())
	toAddr := common.HexToAddress("0x3C97734DfD0376b0b1a57f48e2049A092fD89058")
	location := toAddr.Location()
	t.Log(location.Name())
	params.TestChainConfig.GenesisHash = genesis.Hash()
	blocks, _ := GenerateChain(params.TestChainConfig, genesis, blake3pow.NewFaker(), testdb, 2, gen)
	statedb.AddBalance(addr, big.NewInt(params.Ether*2)) // give me 2 eth
	mockContext := MockChainContext{blocks}

	data := make([]byte, 0, 0)
	etxGasLimit := uint256.NewInt(21000)
	gasTipCap := uint256.NewInt(1)
	gasFeeCap := uint256.NewInt(1)
	temp := etxGasLimit.Bytes32()
	data = append(data, temp[:]...)
	temp = gasTipCap.Bytes32()
	data = append(data, temp[:]...)
	temp = gasFeeCap.Bytes32()
	data = append(data, temp[:]...)

	inner_tx := types.InternalToExternalTx{ChainID: big.NewInt(1), Nonce: 0, GasTipCap: common.Big1, GasFeeCap: common.Big1, Gas: 100000, To: &toAddr, Value: big.NewInt(params.Ether), ETXGasLimit: 21000, ETXGasPrice: common.Big1, ETXGasTip: common.Big1, ETXData: []byte{}, ETXAccessList: nil}
	tx, err := types.SignTx(types.NewTx(&inner_tx), signer, testKey)
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	receipt, err := ApplyTransaction(params.TestChainConfig, mockContext, &common.ZeroAddr, &gasLimit, statedb, blocks[1].Header(), tx, &zero, vm.Config{NoBaseFee: true})
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	t.Log(types.GetInnerForTesting(receipt.Etxs[0]))
	t.Log(*receipt)
	t.Log(receipt.Status)
}

func TestExternalTokenTransfer(t *testing.T) {
	binary := "60806040523480156200001157600080fd5b506040518060400160405280601681526020017f517561692043726f73732d436861696e20546f6b656e00000000000000000000815250600f908162000058919062000b5d565b506040518060400160405280600381526020017f5158430000000000000000000000000000000000000000000000000000000000815250601090816200009f919062000b5d565b5033601160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550683635c9adc5dea00000600e8190555062000127601160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600e546200076c60201b60201c565b6040518060400160405280600060ff168152602001600960ff1681525060126000600d81106200015c576200015b62000c44565b5b0160008201518160000160006101000a81548160ff021916908360ff16021790555060208201518160000160016101000a81548160ff021916908360ff1602179055509050506040518060400160405280600a60ff168152602001601360ff1681525060126001600d8110620001d757620001d662000c44565b5b0160008201518160000160006101000a81548160ff021916908360ff16021790555060208201518160000160016101000a81548160ff021916908360ff1602179055509050506040518060400160405280601460ff168152602001601d60ff1681525060126002600d811062000252576200025162000c44565b5b0160008201518160000160006101000a81548160ff021916908360ff16021790555060208201518160000160016101000a81548160ff021916908360ff1602179055509050506040518060400160405280601e60ff168152602001602760ff1681525060126003600d8110620002cd57620002cc62000c44565b5b0160008201518160000160006101000a81548160ff021916908360ff16021790555060208201518160000160016101000a81548160ff021916908360ff1602179055509050506040518060400160405280602860ff168152602001603160ff1681525060126004600d811062000348576200034762000c44565b5b0160008201518160000160006101000a81548160ff021916908360ff16021790555060208201518160000160016101000a81548160ff021916908360ff1602179055509050506040518060400160405280603260ff168152602001603b60ff1681525060126005600d8110620003c357620003c262000c44565b5b0160008201518160000160006101000a81548160ff021916908360ff16021790555060208201518160000160016101000a81548160ff021916908360ff1602179055509050506040518060400160405280603c60ff168152602001604560ff1681525060126006600d81106200043e576200043d62000c44565b5b0160008201518160000160006101000a81548160ff021916908360ff16021790555060208201518160000160016101000a81548160ff021916908360ff1602179055509050506040518060400160405280604660ff168152602001604f60ff1681525060126007600d8110620004b957620004b862000c44565b5b0160008201518160000160006101000a81548160ff021916908360ff16021790555060208201518160000160016101000a81548160ff021916908360ff1602179055509050506040518060400160405280605060ff168152602001605960ff1681525060126008600d811062000534576200053362000c44565b5b0160008201518160000160006101000a81548160ff021916908360ff16021790555060208201518160000160016101000a81548160ff021916908360ff1602179055509050506040518060400160405280605a60ff168152602001606360ff1681525060126009600d8110620005af57620005ae62000c44565b5b0160008201518160000160006101000a81548160ff021916908360ff16021790555060208201518160000160016101000a81548160ff021916908360ff1602179055509050506040518060400160405280606460ff168152602001606d60ff168152506012600a600d81106200062a576200062962000c44565b5b0160008201518160000160006101000a81548160ff021916908360ff16021790555060208201518160000160016101000a81548160ff021916908360ff1602179055509050506040518060400160405280606e60ff168152602001607760ff168152506012600b600d8110620006a557620006a462000c44565b5b0160008201518160000160006101000a81548160ff021916908360ff16021790555060208201518160000160016101000a81548160ff021916908360ff1602179055509050506040518060400160405280607860ff168152602001608160ff168152506012600c600d811062000720576200071f62000c44565b5b0160008201518160000160006101000a81548160ff021916908360ff16021790555060208201518160000160016101000a81548160ff021916908360ff16021790555090505062000d8e565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603620007de576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620007d59062000cd4565b60405180910390fd5b620007f260008383620008d960201b60201c565b80600e600082825462000806919062000d25565b92505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051620008b9919062000d71565b60405180910390a3620008d560008383620008de60201b60201c565b5050565b505050565b505050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200096557607f821691505b6020821081036200097b576200097a6200091d565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620009e57fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82620009a6565b620009f18683620009a6565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b600062000a3e62000a3862000a328462000a09565b62000a13565b62000a09565b9050919050565b6000819050919050565b62000a5a8362000a1d565b62000a7262000a698262000a45565b848454620009b3565b825550505050565b600090565b62000a8962000a7a565b62000a9681848462000a4f565b505050565b5b8181101562000abe5762000ab260008262000a7f565b60018101905062000a9c565b5050565b601f82111562000b0d5762000ad78162000981565b62000ae28462000996565b8101602085101562000af2578190505b62000b0a62000b018562000996565b83018262000a9b565b50505b505050565b600082821c905092915050565b600062000b326000198460080262000b12565b1980831691505092915050565b600062000b4d838362000b1f565b9150826002028217905092915050565b62000b6882620008e3565b67ffffffffffffffff81111562000b845762000b83620008ee565b5b62000b9082546200094c565b62000b9d82828562000ac2565b600060209050601f83116001811462000bd5576000841562000bc0578287015190505b62000bcc858262000b3f565b86555062000c3c565b601f19841662000be58662000981565b60005b8281101562000c0f5784890151825560018201915060208501945060208101905062000be8565b8683101562000c2f578489015162000c2b601f89168262000b1f565b8355505b6001600288020188555050505b505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600082825260208201905092915050565b7f45524332303a206d696e7420746f20746865207a65726f206164647265737300600082015250565b600062000cbc601f8362000c73565b915062000cc98262000c84565b602082019050919050565b6000602082019050818103600083015262000cef8162000cad565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600062000d328262000a09565b915062000d3f8362000a09565b925082820190508082111562000d5a5762000d5962000cf6565b5b92915050565b62000d6b8162000a09565b82525050565b600060208201905062000d88600083018462000d60565b92915050565b612b2a8062000d9e6000396000f3fe6080604052600436106101095760003560e01c8063593b79fe11610095578063a457c2d711610064578063a457c2d7146103ab578063a9059cbb146103e8578063bc472aa314610418578063dd62ed3e14610455578063e20e50ba1461049257610109565b8063593b79fe146102ea57806370a082311461032757806373cddab21461036457806395d89b411461038057610109565b806323b872dd116100dc57806323b872dd146101ca578063313ce567146102075780633950935114610232578063399444bc1461026f578063429437bf146102ac57610109565b806306fdde031461010e578063095ea7b31461013957806318160ddd1461017657806320e8dd93146101a1575b600080fd5b34801561011a57600080fd5b506101236104bb565b604051610130919061190d565b60405180910390f35b34801561014557600080fd5b50610160600480360381019061015b91906119c8565b61054d565b60405161016d9190611a23565b60405180910390f35b34801561018257600080fd5b5061018b610564565b6040516101989190611a4d565b60405180910390f35b3480156101ad57600080fd5b506101c860048036038101906101c391906119c8565b61056e565b005b3480156101d657600080fd5b506101f160048036038101906101ec9190611a68565b61066c565b6040516101fe9190611a23565b60405180910390f35b34801561021357600080fd5b5061021c61068f565b6040516102299190611ad7565b60405180910390f35b34801561023e57600080fd5b50610259600480360381019061025491906119c8565b610698565b6040516102669190611a23565b60405180910390f35b34801561027b57600080fd5b5061029660048036038101906102919190611af2565b6106c8565b6040516102a39190611ad7565b60405180910390f35b3480156102b857600080fd5b506102d360048036038101906102ce9190611b1f565b6107d5565b6040516102e1929190611b4c565b60405180910390f35b3480156102f657600080fd5b50610311600480360381019061030c9190611af2565b610816565b60405161031e9190611bca565b60405180910390f35b34801561033357600080fd5b5061034e60048036038101906103499190611af2565b61083f565b60405161035b9190611a4d565b60405180910390f35b61037e60048036038101906103799190611bec565b610887565b005b34801561038c57600080fd5b50610395610ac1565b6040516103a2919061190d565b60405180910390f35b3480156103b757600080fd5b506103d260048036038101906103cd91906119c8565b610b53565b6040516103df9190611a23565b60405180910390f35b61040260048036038101906103fd91906119c8565b610bc3565b60405161040f9190611a23565b60405180910390f35b34801561042457600080fd5b5061043f600480360381019061043a9190611b1f565b610c20565b60405161044c9190611c76565b60405180910390f35b34801561046157600080fd5b5061047c60048036038101906104779190611c91565b610c56565b6040516104899190611a4d565b60405180910390f35b34801561049e57600080fd5b506104b960048036038101906104b49190611cfd565b610cdd565b005b6060600f80546104ca90611d6c565b80601f01602080910402602001604051908101604052809291908181526020018280546104f690611d6c565b80156105435780601f1061051857610100808354040283529160200191610543565b820191906000526020600020905b81548152906001019060200180831161052657829003601f168201915b5050505050905090565b600061055a338484610efd565b6001905092915050565b6000600e54905090565b3373ffffffffffffffffffffffffffffffffffffffff166002610590336106c8565b60ff16600c81106105a4576105a3611d9d565b5b0160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614336040516020016105ee9190611e14565b60405160208183030381529060405260405160200161060d9190611f0e565b6040516020818303038152906040529061065d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610654919061190d565b60405180910390fd5b5061066882826110c6565b5050565b600061067984338461121c565b6106848484846112a8565b600190509392505050565b60006012905090565b6000803390506106bd8185856106ae8589610c56565b6106b89190611f6a565b610efd565b600191505092915050565b6000806106d483610816565b6000815181106106e7576106e6611d9d565b5b602001015160f81c60f81b60f81c905060005b600d8160ff1610156107945760128160ff16600d811061071d5761071c611d9d565b5b0160000160009054906101000a900460ff1660ff168260ff1610158015610772575060128160ff16600d811061075657610755611d9d565b5b0160000160019054906101000a900460ff1660ff168260ff1611155b156107815780925050506107d0565b808061078c90611f9e565b9150506106fa565b506040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107c790612013565b60405180910390fd5b919050565b601281600d81106107e557600080fd5b016000915090508060000160009054906101000a900460ff16908060000160019054906101000a900460ff16905082565b6060816040516020016108299190611e14565b6040516020818303038152906040529050919050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b600085f7905080156108ce576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108c59061207f565b60405180910390fd5b6108d8338661151e565b600060026108e5886106c8565b60ff16600c81106108f9576108f8611d9d565b5b0160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050600085858561092c9190611f6a565b610936919061209f565b905080341015610945826116eb565b60405160200161095591906121d0565b604051602081830303815290604052906109a5576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161099c919061190d565b60405180910390fd5b50600088886040516024016109bb9291906121fd565b6040516020818303038152906040527f20e8dd93000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090506000806000835160208501898b8d60008b6000f690508973ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fcf0ee562475620bbcd2f1b0675c8163317513271e4fdbbe9722436f247bd6d998b604051610aad9190611a4d565b60405180910390a350505050505050505050565b606060108054610ad090611d6c565b80601f0160208091040260200160405190810160405280929190818152602001828054610afc90611d6c565b8015610b495780601f10610b1e57610100808354040283529160200191610b49565b820191906000526020600020905b815481529060010190602001808311610b2c57829003601f168201915b5050505050905090565b6000803390506000610b658286610c56565b905083811015610baa576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ba190612298565b60405180910390fd5b610bb78286868403610efd565b60019250505092915050565b60008083f7905080610c0a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c019061232a565b60405180910390fd5b610c153385856112a8565b600191505092915050565b600281600c8110610c3057600080fd5b016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600081f790508015610d24576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d1b9061207f565b60405180910390fd5b601160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610db4576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610dab90612396565b60405180910390fd5b600d8360ff1610610dfa576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610df190612402565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff1660028460ff16600c8110610e2957610e28611d9d565b5b0160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610ea1576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e9890612494565b60405180910390fd5b8160028460ff16600c8110610eb957610eb8611d9d565b5b0160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610f6c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f6390612526565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610fdb576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610fd2906125b8565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925836040516110b99190611a4d565b60405180910390a3505050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603611135576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161112c90612624565b60405180910390fd5b61114160008383611873565b80600e60008282546111539190611f6a565b92505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516112049190611a4d565b60405180910390a361121860008383611878565b5050565b60006112288484610c56565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81146112a25781811015611294576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161128b90612690565b60405180910390fd5b6112a18484848403610efd565b5b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603611317576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161130e90612722565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603611386576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161137d906127b4565b60405180910390fd5b611391838383611873565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015611417576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161140e90612846565b60405180910390fd5b8181036000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040516115059190611a4d565b60405180910390a3611518848484611878565b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361158d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611584906128d8565b60405180910390fd5b61159982600083611873565b60008060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205490508181101561161f576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016116169061296a565b60405180910390fd5b8181036000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555081600e60008282540392505081905550600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040516116d29190611a4d565b60405180910390a36116e683600084611878565b505050565b606060008203611732576040518060400160405280600181526020017f3000000000000000000000000000000000000000000000000000000000000000815250905061186e565b600082905060005b6000821461176457808061174d9061298a565b915050600a8261175d9190612a01565b915061173a565b60008167ffffffffffffffff8111156117805761177f612a32565b5b6040519080825280601f01601f1916602001820160405280156117b25781602001600182028036833780820191505090505b50905060008290505b60008614611866576001816117d09190612a61565b90506000600a80886117e29190612a01565b6117ec919061209f565b876117f79190612a61565b60306118039190612a95565b905060008160f81b90508084848151811061182157611820611d9d565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600a8861185d9190612a01565b975050506117bb565b819450505050505b919050565b505050565b505050565b600081519050919050565b600082825260208201905092915050565b60005b838110156118b757808201518184015260208101905061189c565b60008484015250505050565b6000601f19601f8301169050919050565b60006118df8261187d565b6118e98185611888565b93506118f9818560208601611899565b611902816118c3565b840191505092915050565b6000602082019050818103600083015261192781846118d4565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061195f82611934565b9050919050565b61196f81611954565b811461197a57600080fd5b50565b60008135905061198c81611966565b92915050565b6000819050919050565b6119a581611992565b81146119b057600080fd5b50565b6000813590506119c28161199c565b92915050565b600080604083850312156119df576119de61192f565b5b60006119ed8582860161197d565b92505060206119fe858286016119b3565b9150509250929050565b60008115159050919050565b611a1d81611a08565b82525050565b6000602082019050611a386000830184611a14565b92915050565b611a4781611992565b82525050565b6000602082019050611a626000830184611a3e565b92915050565b600080600060608486031215611a8157611a8061192f565b5b6000611a8f8682870161197d565b9350506020611aa08682870161197d565b9250506040611ab1868287016119b3565b9150509250925092565b600060ff82169050919050565b611ad181611abb565b82525050565b6000602082019050611aec6000830184611ac8565b92915050565b600060208284031215611b0857611b0761192f565b5b6000611b168482850161197d565b91505092915050565b600060208284031215611b3557611b3461192f565b5b6000611b43848285016119b3565b91505092915050565b6000604082019050611b616000830185611ac8565b611b6e6020830184611ac8565b9392505050565b600081519050919050565b600082825260208201905092915050565b6000611b9c82611b75565b611ba68185611b80565b9350611bb6818560208601611899565b611bbf816118c3565b840191505092915050565b60006020820190508181036000830152611be48184611b91565b905092915050565b600080600080600060a08688031215611c0857611c0761192f565b5b6000611c168882890161197d565b9550506020611c27888289016119b3565b9450506040611c38888289016119b3565b9350506060611c49888289016119b3565b9250506080611c5a888289016119b3565b9150509295509295909350565b611c7081611954565b82525050565b6000602082019050611c8b6000830184611c67565b92915050565b60008060408385031215611ca857611ca761192f565b5b6000611cb68582860161197d565b9250506020611cc78582860161197d565b9150509250929050565b611cda81611abb565b8114611ce557600080fd5b50565b600081359050611cf781611cd1565b92915050565b60008060408385031215611d1457611d1361192f565b5b6000611d2285828601611ce8565b9250506020611d338582860161197d565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680611d8457607f821691505b602082108103611d9757611d96611d3d565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60008160601b9050919050565b6000611de482611dcc565b9050919050565b6000611df682611dd9565b9050919050565b611e0e611e0982611954565b611deb565b82525050565b6000611e208284611dfd565b60148201915081905092915050565b600081905092915050565b7f53656e6465722000000000000000000000000000000000000000000000000000600082015250565b6000611e70600783611e2f565b9150611e7b82611e3a565b600782019050919050565b600081905092915050565b6000611e9c82611b75565b611ea68185611e86565b9350611eb6818560208601611899565b80840191505092915050565b7f206e6f7420617070726f76656400000000000000000000000000000000000000600082015250565b6000611ef8600d83611e2f565b9150611f0382611ec2565b600d82019050919050565b6000611f1982611e63565b9150611f258284611e91565b9150611f3082611eeb565b915081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000611f7582611992565b9150611f8083611992565b9250828201905080821115611f9857611f97611f3b565b5b92915050565b6000611fa982611abb565b915060ff8203611fbc57611fbb611f3b565b5b600182019050919050565b7f496e76616c6964204c6f636174696f6e00000000000000000000000000000000600082015250565b6000611ffd601083611888565b915061200882611fc7565b602082019050919050565b6000602082019050818103600083015261202c81611ff0565b9050919050565b7f41646472657373206973206e6f742065787465726e616c000000000000000000600082015250565b6000612069601783611888565b915061207482612033565b602082019050919050565b600060208201905081810360008301526120988161205c565b9050919050565b60006120aa82611992565b91506120b583611992565b92508282026120c381611992565b915082820484148315176120da576120d9611f3b565b5b5092915050565b7f4e6f7420656e6f756768206761732073656e742c206e656564206174206c656160008201527f7374200000000000000000000000000000000000000000000000000000000000602082015250565b600061213d602383611e2f565b9150612148826120e1565b602382019050919050565b600061215e8261187d565b6121688185611e2f565b9350612178818560208601611899565b80840191505092915050565b7f2077656900000000000000000000000000000000000000000000000000000000600082015250565b60006121ba600483611e2f565b91506121c582612184565b600482019050919050565b60006121db82612130565b91506121e78284612153565b91506121f2826121ad565b915081905092915050565b60006040820190506122126000830185611c67565b61221f6020830184611a3e565b9392505050565b7f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f7760008201527f207a65726f000000000000000000000000000000000000000000000000000000602082015250565b6000612282602583611888565b915061228d82612226565b604082019050919050565b600060208201905081810360008301526122b181612275565b9050919050565b7f416464726573732069732065787465726e616c2e205573652063726f73732d6360008201527f6861696e207472616e736665722066756e6374696f6e2e000000000000000000602082015250565b6000612314603783611888565b915061231f826122b8565b604082019050919050565b6000602082019050818103600083015261234381612307565b9050919050565b7f53656e646572206973206e6f74206465706c6f79657200000000000000000000600082015250565b6000612380601683611888565b915061238b8261234a565b602082019050919050565b600060208201905081810360008301526123af81612373565b9050919050565b7f4d617820313320636861696e7300000000000000000000000000000000000000600082015250565b60006123ec600d83611888565b91506123f7826123b6565b602082019050919050565b6000602082019050818103600083015261241b816123df565b9050919050565b7f54686520617070726f766564206164647265737320666f72207468697320636860008201527f61696e20616c7265616479206578697374730000000000000000000000000000602082015250565b600061247e603283611888565b915061248982612422565b604082019050919050565b600060208201905081810360008301526124ad81612471565b9050919050565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b6000612510602483611888565b915061251b826124b4565b604082019050919050565b6000602082019050818103600083015261253f81612503565b9050919050565b7f45524332303a20617070726f766520746f20746865207a65726f20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b60006125a2602283611888565b91506125ad82612546565b604082019050919050565b600060208201905081810360008301526125d181612595565b9050919050565b7f45524332303a206d696e7420746f20746865207a65726f206164647265737300600082015250565b600061260e601f83611888565b9150612619826125d8565b602082019050919050565b6000602082019050818103600083015261263d81612601565b9050919050565b7f45524332303a20696e73756666696369656e7420616c6c6f77616e6365000000600082015250565b600061267a601d83611888565b915061268582612644565b602082019050919050565b600060208201905081810360008301526126a98161266d565b9050919050565b7f45524332303a207472616e736665722066726f6d20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b600061270c602583611888565b9150612717826126b0565b604082019050919050565b6000602082019050818103600083015261273b816126ff565b9050919050565b7f45524332303a207472616e7366657220746f20746865207a65726f206164647260008201527f6573730000000000000000000000000000000000000000000000000000000000602082015250565b600061279e602383611888565b91506127a982612742565b604082019050919050565b600060208201905081810360008301526127cd81612791565b9050919050565b7f45524332303a207472616e7366657220616d6f756e742065786365656473206260008201527f616c616e63650000000000000000000000000000000000000000000000000000602082015250565b6000612830602683611888565b915061283b826127d4565b604082019050919050565b6000602082019050818103600083015261285f81612823565b9050919050565b7f45524332303a206275726e2066726f6d20746865207a65726f2061646472657360008201527f7300000000000000000000000000000000000000000000000000000000000000602082015250565b60006128c2602183611888565b91506128cd82612866565b604082019050919050565b600060208201905081810360008301526128f1816128b5565b9050919050565b7f45524332303a206275726e20616d6f756e7420657863656564732062616c616e60008201527f6365000000000000000000000000000000000000000000000000000000000000602082015250565b6000612954602283611888565b915061295f826128f8565b604082019050919050565b6000602082019050818103600083015261298381612947565b9050919050565b600061299582611992565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036129c7576129c6611f3b565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000612a0c82611992565b9150612a1783611992565b925082612a2757612a266129d2565b5b828204905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000612a6c82611992565b9150612a7783611992565b9250828203905081811115612a8f57612a8e611f3b565b5b92915050565b6000612aa082611abb565b9150612aab83611abb565b9250828201905060ff811115612ac457612ac3611f3b565b5b9291505056fea2646970667358221220868ddaa4933573169de8b6890f85af8f36b6be9ec4249b2f7fc57810ef9bda9464736f6c63782c302e382e31382d646576656c6f702e323032322e31312e382b636f6d6d69742e36306161353861362e6d6f64005d"
	// Create a simple chain to verify
	var statedb *state.StateDB
	gen := func(i int, b *BlockGen) {
		statedb = b.statedb
	}
	var (
		testdb = rawdb.NewMemoryDatabase()
		gspec  = &Genesis{
			Config: params.TestChainConfig,
			Alloc: GenesisAlloc{
				common.HexToAddress("0x71562b71999873DB5b286dF957af199Ec94617F7"): GenesisAccount{
					Balance: big.NewInt(1000000000000000000), // 1 ether
					Nonce:   0,
				},
			},
			GasLimit:   []uint64{params.GenesisGasLimit, params.GenesisGasLimit, params.GenesisGasLimit},
			Difficulty: []*big.Int{common.Big0, common.Big0, common.Big0},
			ParentHash: []common.Hash{common.HexToHash("0"), common.HexToHash("0"), common.HexToHash("0")},
			BaseFee:    []*big.Int{common.Big0, common.Big0, common.Big0},
		}
		genesis    = gspec.MustCommit(testdb)
		signer     = types.LatestSigner(params.TestChainConfig)
		testKey, _ = crypto.HexToECDSA("b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
		addr       = crypto.PubkeyToAddress(testKey.PublicKey)
		zero       = uint64(0)
		gasLimit   = GasPool(params.GenesisGasLimit)
	)
	t.Log(addr)
	common.NodeLocation = *addr.Location()
	t.Log(common.NodeLocation.Name())
	location := common.HexToAddress("0x3C97734DfD0376b0b1a57f48e2049A092fD89058").Location()
	t.Log(location.Name())
	params.TestChainConfig.GenesisHash = genesis.Hash()
	blocks, _ := GenerateChain(params.TestChainConfig, genesis, blake3pow.NewFaker(), testdb, 2, gen)
	statedb.AddBalance(addr, big.NewInt(params.Ether*2)) // give me 2 eth
	mockContext := MockChainContext{blocks}
	// Deploy a contract with the proper address that gives me tokens in zone 2-1
	contract, err := hex.DecodeString(binary)
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	i := uint8(0)
	nonce := uint64(0)
	contract = append(contract, i)
	var contractAddr common.Address
	for {
		contract[len(contract)-1] = i
		contractAddr = crypto.CreateAddress(addr, nonce, contract)
		if contractAddr.IsInChainScope() {
			break
		}
		i++
	}
	inner_tx := types.InternalTx{ChainID: big.NewInt(1), Nonce: 0, GasTipCap: common.Big1, GasFeeCap: common.Big1, Gas: 4000000, To: nil, Value: common.Big0, Data: contract}
	tx, err := types.SignTx(types.NewTx(&inner_tx), signer, testKey)
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	receipt, err := ApplyTransaction(params.TestChainConfig, mockContext, &common.ZeroAddr, &gasLimit, statedb, blocks[1].Header(), tx, &zero, vm.Config{NoBaseFee: true})
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	t.Log(*receipt)
	t.Log(receipt.Status)

	if contractAddr != receipt.ContractAddress {
		t.Errorf("Expected: %s received: %s", contractAddr, receipt.ContractAddress)
		t.Fail()
	}
	// Here, set 0x02 as an approved contract for both zone 1-0 and prime
	sig := crypto.Keccak256([]byte("AddApprovedAddress(uint8,address)"))[:4]
	chain := uint256.NewInt(6)
	approvedAddress := uint256.NewInt(2)
	data := make([]byte, 0, 0)
	data = append(data, sig...)
	temp := chain.Bytes32()
	data = append(data, temp[:]...)
	temp = approvedAddress.Bytes32()
	data = append(data, temp[:]...)
	inner_tx = types.InternalTx{ChainID: big.NewInt(1), Nonce: 1, GasTipCap: common.Big1, GasFeeCap: common.Big1, Gas: 1000000, To: &contractAddr, Value: common.Big0, Data: data}
	tx, err = types.SignTx(types.NewTx(&inner_tx), signer, testKey)
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	receipt, err = ApplyTransaction(params.TestChainConfig, mockContext, &common.ZeroAddr, &gasLimit, statedb, blocks[1].Header(), tx, &zero, vm.Config{NoBaseFee: true})
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	t.Log(*receipt)
	t.Log(receipt.Status)

	data[35] = 0 // Set chain to 0
	inner_tx = types.InternalTx{ChainID: big.NewInt(1), Nonce: 2, GasTipCap: common.Big1, GasFeeCap: common.Big1, Gas: 1000000, To: &contractAddr, Value: common.Big0, Data: data}
	tx, err = types.SignTx(types.NewTx(&inner_tx), signer, testKey)
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	receipt, err = ApplyTransaction(params.TestChainConfig, mockContext, &common.ZeroAddr, &gasLimit, statedb, blocks[1].Header(), tx, &zero, vm.Config{NoBaseFee: true})
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	// Transfer 1 token from my address in zone-2-1 to zone 1-0
	sig = crypto.Keccak256([]byte("crossChainTransfer(address,uint256,uint256,uint256,uint256)"))[:4] // crossChainTransfer(address to, uint256 amount, uint256 gasLimit, uint256 minerTip, uint256 baseFee)
	to, err := uint256.FromHex("0x3C97734DfD0376b0b1a57f48e2049A092fD89058")
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	amount := uint256.NewInt(3)
	limit := uint256.NewInt(100000)
	tip := uint256.NewInt(1)
	baseFee := uint256.NewInt(1)
	data = make([]byte, 0, 0)
	data = append(data, sig...)
	temp = to.Bytes32()
	data = append(data, temp[:]...)
	temp = amount.Bytes32()
	data = append(data, temp[:]...)
	temp = limit.Bytes32()
	data = append(data, temp[:]...)
	temp = tip.Bytes32()
	data = append(data, temp[:]...)
	temp = baseFee.Bytes32()
	data = append(data, temp[:]...)
	value := tip.Add(tip, baseFee).Mul(tip, limit)
	inner_tx = types.InternalTx{ChainID: big.NewInt(1), Nonce: 3, GasTipCap: common.Big1, GasFeeCap: common.Big1, Gas: 1000000, To: &contractAddr, Value: value.ToBig(), Data: data}
	tx, err = types.SignNewTx(testKey, signer, &inner_tx)
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	//tracer := vm.NewMarkdownLogger(nil, os.Stdout)
	receipt, err = ApplyTransaction(params.TestChainConfig, mockContext, &common.ZeroAddr, &gasLimit, statedb, blocks[1].Header(), tx, &zero, vm.Config{Debug: false, Tracer: nil, NoBaseFee: true})
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	t.Log(*receipt)
	t.Log(receipt.Status)
	//vm.WriteTrace(os.Stdout, tracer.StructLogs())
	t.Log(*receipt.Etxs[0])
	// Apply the generated ETX that calls incomingTransfer(). This ETX came from zone-2-1 (our location) but we pretend it came from Prime.
	etx := types.GetInnerForTesting(receipt.Etxs[0]).(*types.ExternalTx)
	sender := etx.Sender
	t.Log(sender.Location().Name())
	etx.Sender = *etx.To
	etx.To = &sender // swap sender and to (pretend it came from somewhere else)
	tx, err = types.SignNewTx(testKey, signer, etx)
	receipt, err = ApplyTransaction(params.TestChainConfig, mockContext, &common.ZeroAddr, &gasLimit, statedb, blocks[1].Header(), tx, &zero, vm.Config{Debug: false, Tracer: nil, NoBaseFee: true})
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	t.Log(*receipt)
	t.Log(receipt.Status)
	// Check balance
	sig = crypto.Keccak256([]byte("balanceOf(address)"))[:4]
	data = make([]byte, 0, 0)
	data = append(data, sig...)
	temp = to.Bytes32() // same 'to' address from above
	data = append(data, temp[:]...)
	msg := types.NewMessage(common.ZeroAddr, &contractAddr, 0, common.Big0, limit.Uint64(), common.Big0, common.Big0, common.Big0, data, nil, false)
	// Apply the transaction to the current state (included in the env).
	blockContext := NewEVMBlockContext(blocks[1].Header(), mockContext, &common.ZeroAddr)
	vmenv := vm.NewEVM(blockContext, vm.TxContext{}, statedb, params.TestChainConfig, vm.Config{NoBaseFee: true})
	result, err := ApplyMessage(vmenv, msg, &gasLimit)
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	t.Log(result.Return())
	balance := big.Int{}
	balance.SetBytes(result.Return())
	if amount.ToBig().Cmp(&balance) != 0 {
		t.Errorf("Have: %s Want: %s", balance.String(), amount.String())
		t.Fail()
	}
}

func TestInboundETX(t *testing.T) {
	// Create a simple chain to verify
	var statedb *state.StateDB
	gen := func(i int, b *BlockGen) {
		statedb = b.statedb
	}
	var (
		testdb = rawdb.NewMemoryDatabase()
		gspec  = &Genesis{
			Config: params.TestChainConfig,
			Alloc: GenesisAlloc{
				common.HexToAddress("0x71562b71999873DB5b286dF957af199Ec94617F7"): GenesisAccount{
					Balance: big.NewInt(1000000000000000000), // 1 ether
					Nonce:   0,
				},
			},
			GasLimit:   []uint64{params.GenesisGasLimit, params.GenesisGasLimit, params.GenesisGasLimit},
			Difficulty: []*big.Int{common.Big0, common.Big0, common.Big0},
			ParentHash: []common.Hash{common.HexToHash("0"), common.HexToHash("0"), common.HexToHash("0")},
			BaseFee:    []*big.Int{common.Big0, common.Big0, common.Big0},
		}
		genesis  = gspec.MustCommit(testdb)
		to       = common.HexToAddress("0x5A457339697CB56E5a9BfA5267eA80d2c6375d98")
		sender   = common.HexToAddress("0x70bcCc6AC5437Bb4339e2D86291bC67Be83a5484")
		gasLimit = GasPool(params.GenesisGasLimit)
		zero     = uint64(0)
	)
	common.NodeLocation = *to.Location()
	params.TestChainConfig.GenesisHash = genesis.Hash()
	blocks, _ := GenerateChain(params.TestChainConfig, genesis, blake3pow.NewFaker(), testdb, 2, gen)
	mockContext := MockChainContext{blocks}
	lastBlock := blocks[len(blocks)-1]
	etxSet := make(types.EtxSet)
	etx := types.ExternalTx{Nonce: 0, GasTipCap: common.Big1, GasFeeCap: common.Big1, Gas: 100000, To: &to, Value: big.NewInt(500000000000000000), Data: []byte{}, AccessList: nil, Sender: sender}
	tx := types.NewTx(&etx)
	transactions := types.Transactions{tx}
	etxSet.Update(transactions, lastBlock.NumberU64())
	rawdb.WriteEtxSet(testdb, lastBlock.Hash(), lastBlock.NumberU64(), etxSet)
	receipt, err := ApplyTransaction(params.TestChainConfig, mockContext, &common.ZeroAddr, &gasLimit, statedb, lastBlock.Header(), tx, &zero, vm.Config{NoBaseFee: true})
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	balance, err := statedb.GetBalance(to)
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	if balance.Cmp(big.NewInt(500000000000000000)) != 0 {
		t.Errorf("Have: %d Want: %d", balance.Int64(), 500000000000000000)
		t.Fail()
	}
	t.Log(*receipt)
	t.Log(receipt.Status)
	t.Log(balance.Int64())
}

func TestInvalidInboundETX(t *testing.T) {
	// Create a simple chain to verify
	var statedb *state.StateDB
	gen := func(i int, b *BlockGen) {
		statedb = b.statedb
	}
	var (
		testdb = rawdb.NewMemoryDatabase()
		gspec  = &Genesis{
			Config: params.TestChainConfig,
			Alloc: GenesisAlloc{
				common.HexToAddress("0x71562b71999873DB5b286dF957af199Ec94617F7"): GenesisAccount{
					Balance: big.NewInt(1000000000000000000), // 1 ether
					Nonce:   0,
				},
			},
			GasLimit:   []uint64{params.GenesisGasLimit, params.GenesisGasLimit, params.GenesisGasLimit},
			Difficulty: []*big.Int{common.Big0, common.Big0, common.Big0},
			ParentHash: []common.Hash{common.HexToHash("0"), common.HexToHash("0"), common.HexToHash("0")},
			BaseFee:    []*big.Int{common.Big0, common.Big0, common.Big0},
		}
		genesis  = gspec.MustCommit(testdb)
		to       = common.HexToAddress("0x5A457339697CB56E5a9BfA5267eA80d2c6375d98")
		sender   = common.HexToAddress("0x70bcCc6AC5437Bb4339e2D86291bC67Be83a5484")
		gasLimit = GasPool(params.GenesisGasLimit)
		zero     = uint64(0)
	)
	common.NodeLocation = *to.Location()
	params.TestChainConfig.GenesisHash = genesis.Hash()
	blocks, _ := GenerateChain(params.TestChainConfig, genesis, blake3pow.NewFaker(), testdb, 2, gen)
	mockContext := MockChainContext{blocks}
	lastBlock := blocks[len(blocks)-1]
	etx := types.ExternalTx{Nonce: 0, GasTipCap: common.Big1, GasFeeCap: common.Big1, Gas: 100000, To: &to, Value: big.NewInt(500000000000000000), Data: []byte{}, AccessList: nil, Sender: sender}
	tx := types.NewTx(&etx)
	_, err := ApplyTransaction(params.TestChainConfig, mockContext, &common.ZeroAddr, &gasLimit, statedb, lastBlock.Header(), tx, &zero, vm.Config{NoBaseFee: true})
	if err == nil {
		t.Fail()
	}
	t.Error(err.Error())
}

// 60806040
func TestOpETX(t *testing.T) {
	// Create a simple chain to verify
	var statedb *state.StateDB
	gen := func(i int, b *BlockGen) {
		statedb = b.statedb
	}
	var (
		testdb = rawdb.NewMemoryDatabase()
		gspec  = &Genesis{
			Config: params.TestChainConfig,
			Alloc: GenesisAlloc{
				common.HexToAddress("0x71562b71999873DB5b286dF957af199Ec94617F7"): GenesisAccount{
					Balance: big.NewInt(1000000000000000000), // 1 ether
					Nonce:   0,
				},
			},
			GasLimit:   []uint64{params.GenesisGasLimit, params.GenesisGasLimit, params.GenesisGasLimit},
			Difficulty: []*big.Int{common.Big0, common.Big0, common.Big0},
			ParentHash: []common.Hash{common.HexToHash("0"), common.HexToHash("0"), common.HexToHash("0")},
			BaseFee:    []*big.Int{common.Big0, common.Big0, common.Big0},
		}
		genesis    = gspec.MustCommit(testdb)
		signer     = types.LatestSigner(params.TestChainConfig)
		testKey, _ = crypto.HexToECDSA("b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
		addr       = crypto.PubkeyToAddress(testKey.PublicKey)
		zero       = uint64(0)
		gasLimit   = GasPool(params.GenesisGasLimit)
	)
	t.Log(addr)
	common.NodeLocation = *addr.Location()
	params.TestChainConfig.GenesisHash = genesis.Hash()
	blocks, _ := GenerateChain(params.TestChainConfig, genesis, blake3pow.NewFaker(), testdb, 2, gen)
	statedb.AddBalance(addr, big.NewInt(params.Ether*2)) // give me 2 eth
	mockContext := MockChainContext{blocks}
	//contract, err := hex.DecodeString("6080604052600060006000600060016001620186a06706f05b59d3b20000735a457339697cb56e5a9bfa5267ea80d2c6375d986000f660008060393d393df3")
	contract, err := hex.DecodeString("60806040526000806000806000600180620186a06706f05b59d3b20000735a457339697cb56e5a9bfa5267ea80d2c6375d986000f690505060698060446000396000f3fe6080604052600080fdfea2646970667358221220d51a551dccdf100829b6e928e928be7c4b803430100a5e618686c4ab3d17280964736f6c63782c302e382e31382d646576656c6f702e323032322e31312e372b636f6d6d69742e32636336363130652e6d6f64005d")
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	i := uint8(0)
	nonce := uint64(0)
	contract = append(contract, i)
	for {
		contract[len(contract)-1] = i
		contractAddr := crypto.CreateAddress(addr, nonce, contract)
		if contractAddr.IsInChainScope() {
			break
		}
		i++
	}
	inner_tx := types.InternalTx{ChainID: big.NewInt(1), Nonce: 0, GasTipCap: common.Big1, GasFeeCap: common.Big1, Gas: 100000, To: nil, Value: big.NewInt(params.Ether), Data: contract}
	tx, err := types.SignTx(types.NewTx(&inner_tx), signer, testKey)
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	receipt, err := ApplyTransaction(params.TestChainConfig, mockContext, &common.ZeroAddr, &gasLimit, statedb, blocks[1].Header(), tx, &zero, vm.Config{NoBaseFee: true})
	if err != nil {
		t.Error(err.Error())
		t.Fail()
	}
	t.Log(types.GetInnerForTesting(receipt.Etxs[0]))
	t.Log(receipt.Status)

}

// TestStateProcessorErrors tests the output from the 'core' errors
// as defined in core/error.go. These errors are generated when the
// blockchain imports bad blocks, meaning blocks which have valid headers but
// contain invalid transactions
func TestStateProcessorErrors(t *testing.T) {
	var (
		config = &params.ChainConfig{
			ChainID:             big.NewInt(1),
			HomesteadBlock:      big.NewInt(0),
			EIP150Block:         big.NewInt(0),
			EIP155Block:         big.NewInt(0),
			EIP158Block:         big.NewInt(0),
			ByzantiumBlock:      big.NewInt(0),
			ConstantinopleBlock: big.NewInt(0),
			PetersburgBlock:     big.NewInt(0),
			IstanbulBlock:       big.NewInt(0),
			MuirGlacierBlock:    big.NewInt(0),
			BerlinBlock:         big.NewInt(0),
			LondonBlock:         big.NewInt(0),
			Blake3pow:           new(params.Blake3powConfig),
		}
		signer     = types.LatestSigner(config)
		testKey, _ = crypto.HexToECDSA("b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
	)
	var makeTx = func(nonce uint64, to common.Address, amount *big.Int, gasLimit uint64, gasPrice *big.Int, data []byte) *types.Transaction {
		tx, _ := types.SignTx(types.NewTx(&types.InternalTx{ChainID: big.NewInt(9000), Nonce: nonce, GasTipCap: common.Big0, GasFeeCap: gasPrice, Gas: gasLimit, To: &to, Value: amount, Data: data}), signer, testKey)
		return tx
	}
	var mkDynamicTx = func(nonce uint64, to common.Address, gasLimit uint64, gasTipCap, gasFeeCap *big.Int) *types.Transaction {
		tx, _ := types.SignTx(types.NewTx(&types.InternalTx{
			Nonce:     nonce,
			GasTipCap: gasTipCap,
			GasFeeCap: gasFeeCap,
			Gas:       gasLimit,
			To:        &to,
			Value:     big.NewInt(0),
		}), signer, testKey)
		return tx
	}
	{ // Tests against a 'recent' chain definition
		var (
			db    = rawdb.NewMemoryDatabase()
			gspec = &Genesis{
				Config: config,
				Alloc: GenesisAlloc{
					common.HexToAddress("0x71562b71999873DB5b286dF957af199Ec94617F7"): GenesisAccount{
						Balance: big.NewInt(1000000000000000000), // 1 ether
						Nonce:   0,
					},
				},
			}
			_             = gspec.MustCommit(db)
			blockchain, _ = NewHeaderChain(db, blake3pow.NewFaker(), gspec.Config, nil, vm.Config{})
		)
		defer blockchain.Stop()
		bigNumber := new(big.Int).SetBytes(common.FromHex("0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"))
		tooBigNumber := new(big.Int).Set(bigNumber)
		tooBigNumber.Add(tooBigNumber, common.Big1)
		for i, tt := range []struct {
			txs  []*types.Transaction
			want string
		}{
			{ // ErrNonceTooLow
				txs: []*types.Transaction{
					makeTx(0, common.Address{}, big.NewInt(0), params.TxGas, big.NewInt(875000000), nil),
					makeTx(0, common.Address{}, big.NewInt(0), params.TxGas, big.NewInt(875000000), nil),
				},
				want: "could not apply tx 1 [0x0026256b3939ed97e2c4a6f3fce8ecf83bdcfa6d507c47838c308a1fb0436f62]: nonce too low: address 0x71562b71999873DB5b286dF957af199Ec94617F7, tx: 0 state: 1",
			},
			{ // ErrNonceTooHigh
				txs: []*types.Transaction{
					makeTx(100, common.Address{}, big.NewInt(0), params.TxGas, big.NewInt(875000000), nil),
				},
				want: "could not apply tx 0 [0xdebad714ca7f363bd0d8121c4518ad48fa469ca81b0a081be3d10c17460f751b]: nonce too high: address 0x71562b71999873DB5b286dF957af199Ec94617F7, tx: 100 state: 0",
			},
			{ // ErrGasLimitReached
				txs: []*types.Transaction{
					makeTx(0, common.Address{}, big.NewInt(0), 21000000, big.NewInt(875000000), nil),
				},
				want: "could not apply tx 0 [0xbd49d8dadfd47fb846986695f7d4da3f7b2c48c8da82dbc211a26eb124883de9]: gas limit reached",
			},
			{ // ErrInsufficientFundsForTransfer
				txs: []*types.Transaction{
					makeTx(0, common.Address{}, big.NewInt(1000000000000000000), params.TxGas, big.NewInt(875000000), nil),
				},
				want: "could not apply tx 0 [0x98c796b470f7fcab40aaef5c965a602b0238e1034cce6fb73823042dd0638d74]: insufficient funds for gas * price + value: address 0x71562b71999873DB5b286dF957af199Ec94617F7 have 1000000000000000000 want 1000018375000000000",
			},
			{ // ErrInsufficientFunds
				txs: []*types.Transaction{
					makeTx(0, common.Address{}, big.NewInt(0), params.TxGas, big.NewInt(900000000000000000), nil),
				},
				want: "could not apply tx 0 [0x4a69690c4b0cd85e64d0d9ea06302455b01e10a83db964d60281739752003440]: insufficient funds for gas * price + value: address 0x71562b71999873DB5b286dF957af199Ec94617F7 have 1000000000000000000 want 18900000000000000000000",
			},
			// ErrGasUintOverflow
			// One missing 'core' error is ErrGasUintOverflow: "gas uint64 overflow",
			// In order to trigger that one, we'd have to allocate a _huge_ chunk of data, such that the
			// multiplication len(data) +gas_per_byte overflows uint64. Not testable at the moment
			{ // ErrIntrinsicGas
				txs: []*types.Transaction{
					makeTx(0, common.Address{}, big.NewInt(0), params.TxGas-1000, big.NewInt(875000000), nil),
				},
				want: "could not apply tx 0 [0xcf3b049a0b516cb4f9274b3e2a264359e2ba53b2fb64b7bda2c634d5c9d01fca]: intrinsic gas too low: have 20000, want 21000",
			},
			{ // ErrGasLimitReached
				txs: []*types.Transaction{
					makeTx(0, common.Address{}, big.NewInt(0), params.TxGas*1000, big.NewInt(875000000), nil),
				},
				want: "could not apply tx 0 [0xbd49d8dadfd47fb846986695f7d4da3f7b2c48c8da82dbc211a26eb124883de9]: gas limit reached",
			},
			{ // ErrFeeCapTooLow
				txs: []*types.Transaction{
					mkDynamicTx(0, common.Address{}, params.TxGas, big.NewInt(0), big.NewInt(0)),
				},
				want: "could not apply tx 0 [0xc4ab868fef0c82ae0387b742aee87907f2d0fc528fc6ea0a021459fb0fc4a4a8]: max fee per gas less than block base fee: address 0x71562b71999873DB5b286dF957af199Ec94617F7, maxFeePerGas: 0 baseFee: 875000000",
			},
			{ // ErrTipVeryHigh
				txs: []*types.Transaction{
					mkDynamicTx(0, common.Address{}, params.TxGas, tooBigNumber, big.NewInt(1)),
				},
				want: "could not apply tx 0 [0x15b8391b9981f266b32f3ab7da564bbeb3d6c21628364ea9b32a21139f89f712]: max priority fee per gas higher than 2^256-1: address 0x71562b71999873DB5b286dF957af199Ec94617F7, maxPriorityFeePerGas bit length: 257",
			},
			{ // ErrFeeCapVeryHigh
				txs: []*types.Transaction{
					mkDynamicTx(0, common.Address{}, params.TxGas, big.NewInt(1), tooBigNumber),
				},
				want: "could not apply tx 0 [0x48bc299b83fdb345c57478f239e89814bb3063eb4e4b49f3b6057a69255c16bd]: max fee per gas higher than 2^256-1: address 0x71562b71999873DB5b286dF957af199Ec94617F7, maxFeePerGas bit length: 257",
			},
			{ // ErrTipAboveFeeCap
				txs: []*types.Transaction{
					mkDynamicTx(0, common.Address{}, params.TxGas, big.NewInt(2), big.NewInt(1)),
				},
				want: "could not apply tx 0 [0xf987a31ff0c71895780a7612f965a0c8b056deb54e020bb44fa478092f14c9b4]: max priority fee per gas higher than max fee per gas: address 0x71562b71999873DB5b286dF957af199Ec94617F7, maxPriorityFeePerGas: 2, maxFeePerGas: 1",
			},
			{ // ErrInsufficientFunds
				// Available balance:           1000000000000000000
				// Effective cost:                   18375000021000
				// FeeCap * gas:                1050000000000000000
				// This test is designed to have the effective cost be covered by the balance, but
				// the extended requirement on FeeCap*gas < balance to fail
				txs: []*types.Transaction{
					mkDynamicTx(0, common.Address{}, params.TxGas, big.NewInt(1), big.NewInt(50000000000000)),
				},
				want: "could not apply tx 0 [0x413603cd096a87f41b1660d3ed3e27d62e1da78eac138961c0a1314ed43bd129]: insufficient funds for gas * price + value: address 0x71562b71999873DB5b286dF957af199Ec94617F7 have 1000000000000000000 want 1050000000000000000",
			},
			{ // Another ErrInsufficientFunds, this one to ensure that feecap/tip of max u256 is allowed
				txs: []*types.Transaction{
					mkDynamicTx(0, common.Address{}, params.TxGas, bigNumber, bigNumber),
				},
				want: "could not apply tx 0 [0xd82a0c2519acfeac9a948258c47e784acd20651d9d80f9a1c67b4137651c3a24]: insufficient funds for gas * price + value: address 0x71562b71999873DB5b286dF957af199Ec94617F7 have 1000000000000000000 want 2431633873983640103894990685182446064918669677978451844828609264166175722438635000",
			},
		} {
			var err error
			//block := GenerateBadBlock(genesis, blake3pow.NewFaker(), tt.txs, gspec.Config)
			//_, err := blockchain.InsertChain(types.Blocks{block})
			if err == nil {
				t.Fatal("block imported without errors")
			}
			if have, want := err.Error(), tt.want; have != want {
				t.Errorf("test %d:\nhave \"%v\"\nwant \"%v\"\n", i, have, want)
			}
		}
	}
}
