name: Go

on: push
  #pull_request:
  #  types: [closed]
  #  branches: [ "main" ]
jobs:

  build:
    #if: github.event.pull_request.merged == true

    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.17

    - name: Install dependencies
      run: sudo apt-get install make build-essential

    - name: create network.env
      run: cat ./network.env.dist | sed "s/WS_API=eth,net,web3,quai/WS_API=eth,net,web3,quai,txpool/g" | sed "s/HTTP_API=eth,net,web3/HTTP_API=eth,net,web3,quai,txpool/g" > ./network.env

    - name: build
      run: go run build/ci.go install ./cmd/quai

    - name: Build
      run: make go-quai

    #- name: Test
    #  run: go test -v

    - name: Build Docker
      run: docker build . -t quainetwork/go-quai:$(cat VERSION) -t quainetwork/go-quai:latest

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: hubchub
        password: ${{ secrets.DOCKER}}

    - name: show
      run: docker push quainetwork/go-quai:$(cat VERSION)

    - name: git tag
      run: git tag $(cat VERSION) && git push origin $(cat VERSION)

    - name: Update Chart.yaml version
      uses: mikefarah/yq@master
      with:
        cmd: yq eval ".appVersion=\"$(cat VERSION)\"" ./go-quai-chart/Chart.yaml

    - name: Deploy
      uses: WyriHaximus/github-action-helm3@v2
      with:
        exec: helm upgrade go-quai ./go-quai-chart --install --wait --atomic --namespace=quai-prod --values=./go-quai-chart/env/quai-prod.values.yaml
        kubeconfig: '${{ secrets.KUBECONFIG }}'

    - name: Update version
      run: awk -F. '{print $1"."$2"."$3"."$4+1}' VERSION > tmp && mv tmp VERSION

    - uses: stefanzweifel/git-auto-commit-action@v4


   # - uses: azure/setup-helm@v3
   #   with:
   #     version: 'default' # default is latest stable
   #   id: install

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
